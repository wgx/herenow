(function(){ const SERVER_URL='https://herenow-anhz7w.fly.dev'; const PING_INTERVAL_MS=15000; const SESSION_STORAGE_KEY='liveCounterSessionId'; const counterElements=document.querySelectorAll('.herenow'); if(counterElements.length===0){ console.error('Live counter element with class "herenow" not found.'); return; } const pageIdentifier=window.location.hostname+window.location.pathname; let isFirstLoad=true; function getSessionId(){ let sessionId=sessionStorage.getItem(SESSION_STORAGE_KEY); if(!sessionId){ sessionId=Date.now().toString(36)+Math.random().toString(36).substring(2); sessionStorage.setItem(SESSION_STORAGE_KEY,sessionId); } return sessionId; } const sessionId=getSessionId(); async function sendPing(){ try{ await fetch(`${SERVER_URL}/ping`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({sessionId:sessionId,page:pageIdentifier}), }); }catch(error){ console.error('Failed to send ping:',error); } } async function fetchAndUpdateCount(){ try{ const safePageIdentifier=encodeURIComponent(pageIdentifier); const response=await fetch(`${SERVER_URL}/count?page=${safePageIdentifier}`); if(!response.ok)throw new Error(`Server responded with status: ${response.status}`); const data=await response.json(); let userCount=data.count||0; if(isFirstLoad&&userCount===0){ userCount=1; } isFirstLoad=false; const userText=userCount===1?'user':'users'; const newText=`${userCount} ${userText} here now`; counterElements.forEach(el=>{ el.textContent=newText; }); }catch(error){ console.error('Failed to fetch count:',error); counterElements.forEach(el=>{ el.textContent='Herenow count unavailable'; }); } } sendPing(); fetchAndUpdateCount(); setInterval(sendPing,PING_INTERVAL_MS); setInterval(fetchAndUpdateCount,PING_INTERVAL_MS); window.addEventListener('beforeunload',function(){ const data=new Blob([JSON.stringify({sessionId:sessionId,page:pageIdentifier})],{type:'application/json'}); navigator.sendBeacon(`${SERVER_URL}/ping`,data); }); })();